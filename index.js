const express = require('express');
const router = express.Router();
const htmlEncode = require('htmlencode').htmlEncode;
const bodyParser = require('body-parser');
const app = express();

const redis = require("redis"),
    client = redis.createClient();

// error handler
client.on("error", function (err) {
    console.log("Error " + err);
});

// initialize bodyParser ans set limits
app.use(bodyParser.json({ limit: '5mb' }));
app.use(bodyParser.urlencoded({ limit: '5mb', extended: true }));

router.route('/data')
    .get((req, res) => {
        client.hkeys("comment", function (err, replies) {
            console.log(replies)
            // res.setHeader('content-type', 'plain/html');
            res.send(replies);
        });
    })
    .post((req, res) => {
        client.hset(["comment", req.body.comment, "a comment"], redis.print);
        res.send({'status': 'success'});
    });

router.route('/vulnerable')
    .get((req, res) => {
        client.hkeys("comment", function (err, replies) {
            let html = '<html><head>'
                + '</head><body class="container">'
                + '<h3>cve test 3 - vulnerable</h3>'
                + '<b>my comments</b:><hr>';
            replies.forEach(reply => {
                html += '<div>'
                    + reply
                    + '</div>';
            });
            html+= '</body></html>';
            res.setHeader('content-type', 'text/html');
            res.send(html);
        });
    });

router.route('/protected')
    .get((req, res) => {
        client.hkeys("comment", function (err, replies) {
            let html = '<html><head>'
                + '</head><body class="container">'
                + '<h3>cve test 3 - protected</h3>'
                + '<b>my comments</b:><hr>';
            replies.forEach(reply => {
                html += '<div>'
                    + reply
                    + '</div>';
            });
            html+= '</body></html>';
            res.setHeader('content-type', 'text/html');
            res.send(htmlEncode(html));
        });
    });

app.use('/api', router);

// static routes
app.use(express.static(`${__dirname}/public`));

// start application
module.exports = app.listen(8000);